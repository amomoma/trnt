name: Large Torrent → Direct Split → Upload (Structured)

on:
  workflow_dispatch:
    inputs:
      torrent_source:
        description: "Magnet link OR .torrent URL"
        required: true
      split_size:
        description: "Split size (e.g. 1G, 500M)"
        required: false
        default: "1G"

jobs:
  upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 curl coreutils jq

      - name: Prepare workspace
        run: |
          mkdir -p work/download
          mkdir -p work/splits

      - name: Show initial disk space
        run: df -h

      - name: Download torrent (Optimized + Logged)
        run: |
          cd work/download
          echo "Starting torrent download..."

          aria2c \
            --dir=. \
            --file-allocation=none \
            --seed-time=0 \
            --enable-dht=true \
            --bt-enable-lpd=true \
            --bt-save-metadata=true \
            --bt-max-peers=100 \
            --max-connection-per-server=16 \
            --split=16 \
            --min-split-size=10M \
            --summary-interval=30 \
            --console-log-level=notice \
            "${{ github.event.inputs.torrent_source }}"

          echo "Download finished."
          ls -Rlh

      - name: Show disk usage after download
        run: df -h

      - name: Recursive Direct Split (Preserve Structure)
        run: |
          cd work
          echo "Starting recursive split with structure preservation..."

          find download -type f ! -name "*.torrent" | while read file; do
            relpath="${file#download/}"
            target_dir="splits/$(dirname "$relpath")"

            mkdir -p "$target_dir"

            echo "Splitting $relpath ..."

            split -b ${{ github.event.inputs.split_size }} \
                  --numeric-suffixes=1 \
                  --suffix-length=4 \
                  "$file" "$target_dir/$(basename "$relpath").part."

            echo "Deleting original file to free space..."
            rm "$file"
          done

          echo "Split structure:"
          ls -Rlh splits

      - name: Upload to Filebin (Preserve Paths)
        run: |
          cd work/splits
          BIN_NAME="github-$(date +%s)"
          echo "Uploading to Filebin: $BIN_NAME"

          find . -type f | while read f; do
            clean_path="${f#./}"
            encoded_path=$(printf '%s' "$clean_path" | jq -s -R -r @uri)

            echo "Uploading $clean_path ..."

            curl --globoff --progress-bar \
                 -T "$clean_path" \
                 "https://filebin.net/$BIN_NAME/$encoded_path"
          done

          echo ""
          echo "======================================"
          echo "✅ Upload complete!"
          echo "Download link:"
          echo "https://filebin.net/$BIN_NAME"
          echo "======================================"
