name: Large Torrent → Direct Split → Upload with Manifest

on:
  workflow_dispatch:
    inputs:
      torrent_source:
        description: "Magnet link OR .torrent URL"
        required: true
      split_size:
        description: "Split size (e.g. 1G, 500M)"
        required: false
        default: "1G"

jobs:
  upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 curl coreutils python3

      - name: Prepare workspace
        run: |
          mkdir -p work/download
          mkdir -p work/splits
          mkdir -p work/logs

      - name: Show initial disk space
        run: df -h | tee work/logs/disk_initial.log

      - name: Download torrent (Optimized)
        run: |
          cd work/download
          echo "Starting torrent download..."

          aria2c \
            --dir=. \
            --file-allocation=none \
            --seed-time=0 \
            --enable-dht=true \
            --bt-enable-lpd=true \
            --bt-save-metadata=true \
            --bt-max-peers=100 \
            --max-connection-per-server=16 \
            --split=16 \
            --min-split-size=10M \
            --summary-interval=30 \
            --console-log-level=notice \
            "${{ github.event.inputs.torrent_source }}"

          if [ $? -ne 0 ]; then
            echo "❌ Download failed!"
            exit 1
          fi

          echo "✅ Download finished successfully."
          ls -lh

      - name: Show disk usage after download
        run: df -h | tee work/logs/disk_after_download.log

      - name: Direct Split (Recursive, No Compression) + Generate Robust Manifest
        run: |
          cd work
          echo "Starting recursive split with collision-safe naming..."

          > splits/MANIFEST_METADATA.txt

          echo "# Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> splits/MANIFEST_METADATA.txt
          echo "# Format: TYPE|HASH|ENCODED_ORIGINAL_PATH|SAFE_NAME|PART_COUNT" >> splits/MANIFEST_METADATA.txt
          echo "" >> splits/MANIFEST_METADATA.txt

          echo "Scanning for empty directories..."
          find download -type d -empty | while read -r dir; do
            rel_path="${dir#download/}"
            if [ -n "$rel_path" ]; then
              hash=$(echo -n "$rel_path" | sha256sum | cut -c1-8)
              encoded_path=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$rel_path', safe=''))")
              echo "EMPTY_DIR|$hash|$encoded_path||" >> splits/MANIFEST_METADATA.txt
            fi
          done

          echo "Scanning and splitting files..."
          find download -type f | sort | while read -r file; do
            rel_path="${file#download/}"
            hash=$(echo -n "$rel_path" | sha256sum | cut -c1-8)
            safe_name="${hash}_$(echo "$rel_path" | sed 's|/|_|g')"

            echo "Splitting $rel_path..."

            split -b ${{ github.event.inputs.split_size }} \
                  --numeric-suffixes=1 \
                  --suffix-length=4 \
                  "$file" "splits/${safe_name}.part."

            part_count=$(ls "splits/${safe_name}.part."* 2>/dev/null | wc -l)

            encoded_path=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$rel_path', safe=''))")

            echo "FILE|$hash|$encoded_path|${safe_name}|${part_count}" >> splits/MANIFEST_METADATA.txt

            rm "$file"
          done

          echo "Split complete."
          ls -lh splits | head -20

      - name: Validate Manifest
        run: |
          cd work/splits

          if [ ! -f MANIFEST_METADATA.txt ]; then
            echo "❌ Manifest missing!"
            exit 1
          fi

          file_entries=$(grep "^FILE|" MANIFEST_METADATA.txt | wc -l)
          dir_entries=$(grep "^EMPTY_DIR|" MANIFEST_METADATA.txt | wc -l)

          echo "Manifest validated:"
          echo "File entries: $file_entries"
          echo "Directory entries: $dir_entries"

      - name: Show disk usage before upload
        run: df -h | tee work/logs/disk_before_upload.log

      # ✅ FIXED SECTION STARTS HERE
      - name: Generate BIN name (persistent)
        run: |
          cd work
          BIN_NAME="github-$(date +%s)"
          echo "$BIN_NAME" > logs/bin_name.txt
          echo "Using BIN_NAME: $BIN_NAME"

      - name: Upload to Filebin (with Retries and Robust Error Handling)
        run: |
          cd work/splits
          BIN_NAME=$(cat ../logs/bin_name.txt)

          RETRY_COUNT=3
          RETRY_DELAY=5

          echo "Uploading to Filebin: $BIN_NAME"
          echo ""

          upload_with_retry() {
            local file=$1
            local encoded_filename=$2
            local retries=$RETRY_COUNT

            while [ $retries -gt 0 ]; do
              if curl --progress-bar --max-time 300 -T "$file" "https://filebin.net/$BIN_NAME/$encoded_filename" 2>/dev/null; then
                return 0
              else
                retries=$((retries - 1))
                if [ $retries -gt 0 ]; then
                  echo "Retrying in ${RETRY_DELAY}s..."
                  sleep $RETRY_DELAY
                fi
              fi
            done

            return 1
          }

          echo "Uploading MANIFEST_METADATA.txt..."
          upload_with_retry "MANIFEST_METADATA.txt" "MANIFEST_METADATA.txt" || exit 1

          total_files=$(ls *.part.* | wc -l)
          uploaded_count=0

          for file in *.part.*; do
            encoded_filename=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$file', safe=''))")
            echo "Uploading $file ..."
            upload_with_retry "$file" "$encoded_filename" || exit 1
            uploaded_count=$((uploaded_count + 1))
          done

          echo ""
          echo "Upload complete!"
          echo "Filebin URL:"
          echo "https://filebin.net/$BIN_NAME"

      - name: Verify manifest on Filebin
        run: |
          cd work
          BIN_NAME=$(cat logs/bin_name.txt)

          echo "Verifying manifest from bin: $BIN_NAME"
          sleep 3

          manifest_content=$(curl -s "https://filebin.net/$BIN_NAME/MANIFEST_METADATA.txt")

          if echo "$manifest_content" | grep -q "^FILE|"; then
            echo "✅ Manifest verified successfully!"
          else
            echo "❌ Manifest verification failed!"
            exit 1
          fi
