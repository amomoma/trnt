name: Large Torrent → Direct Split → Upload with Manifest

on:
  workflow_dispatch:
    inputs:
      torrent_source:
        description: "Magnet link OR .torrent URL"
        required: true
      split_size:
        description: "Split size (e.g. 1G, 500M)"
        required: false
        default: "1G"

jobs:
  upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 curl coreutils python3

      - name: Prepare workspace
        run: |
          mkdir -p work/download
          mkdir -p work/splits

      - name: Show initial disk space
        run: df -h

      - name: Download torrent (Optimized)
        run: |
          cd work/download
          echo "Starting torrent download..."

          aria2c \
            --dir=. \
            --file-allocation=none \
            --seed-time=0 \
            --enable-dht=true \
            --bt-enable-lpd=true \
            --bt-save-metadata=true \
            --bt-max-peers=100 \
            --max-connection-per-server=16 \
            --split=16 \
            --min-split-size=10M \
            --summary-interval=30 \
            --console-log-level=notice \
            "${{ github.event.inputs.torrent_source }}"

          echo "Download finished."
          ls -lh

      - name: Show disk usage after download
        run: df -h

      - name: Direct Split (Recursive, No Compression) + Generate Manifest
        run: |
          cd work
          echo "Starting recursive split..."

          # Create manifest file to track original structure
          > splits/MANIFEST.txt

          # Find all files in the 'download' directory and process them
          find download -type f | while read -r file; do
            # Remove leading "download/" from path to preserve folder structure
            rel_path="${file#download/}"

            # Convert folder separators (/) to underscores (_) for safe naming
            safe_name=$(echo "$rel_path" | sed 's|/|_|g')

            echo "Splitting $rel_path ..."

            # Split the file into chunks based on the split_size input
            split -b ${{ github.event.inputs.split_size }} \
                  --numeric-suffixes=1 \
                  --suffix-length=4 \
                  "$file" "splits/${safe_name}.part."

            # Record the mapping in manifest: original_path|safe_name
            echo "$rel_path|${safe_name}" >> splits/MANIFEST.txt

            echo "Deleting original file..."
            rm "$file"
          done

          echo "Split parts created:"
          ls -lh splits

      - name: Upload to Filebin (with Manifest and Proper URL Encoding)
        run: |
          cd work/splits
          BIN_NAME="github-$(date +%s)"
          echo "Uploading to Filebin: $BIN_NAME"

          # Upload MANIFEST.txt first (most important!)
          echo "Uploading MANIFEST.txt..."
          curl --progress-bar -T "MANIFEST.txt" "https://filebin.net/$BIN_NAME/MANIFEST.txt"

          echo ""

          # Loop through each split file and upload with proper URL encoding
          for file in *.part.*; do
            # Proper URL encoding: encode ALL special characters including &, =, ?, #, etc.
            # safe='' means encode everything except alphanumeric and -_.~
            encoded_filename=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$file', safe=''))")

            echo "Uploading $file as $encoded_filename ..."

            # Upload the file with the properly encoded filename
            curl --progress-bar -T "$file" "https://filebin.net/$BIN_NAME/$encoded_filename"
          done

          echo ""
          echo "======================================"
          echo "✅ Upload complete!"
          echo "Download link:"
          echo "https://filebin.net/$BIN_NAME"
          echo "======================================"
          echo "Bin ID: $BIN_NAME"
